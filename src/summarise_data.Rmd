---
title: "Summary of psychological ownership survey answers"
author: "Abigail Edwards and Mikko Arvas"
date: "`r Sys.time()`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    theme: united
---





```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(gtsummary)
library(likert)
library(readxl)
library(here)
library(corrplot)
library(ggstats)

# https://github.com/cjvanlissa/worcs
# https://cjvanlissa.github.io/worcs/articles/setup.html
# worcs::check_worcs_installation() 

#install.packages("tinytex", dependencies = TRUE)
#library("tinytex")
#install_tinytex()


# https://cjvanlissa.github.io/worcs/reference/add_preregistration.html which template ? 
# https://github.com/crsh/prereg
```


# Data

## Import

```{r}
# file <- here("data/Tulokset - xxxxx.xlsx")
# data <- read_xlsx(file,n_max = XX)
# summary(data)
```

Items
<table>
<tr>
<td></td>
<td> Psychological ownership</td>
</tr>
<tr>
<td>po01</td>
<td>
1. I feel a very high degree of personal ownership of donating blood.
</td>
</tr>
<tr>
<td>po02</td>
<td>
2. I feel like donating blood belongs to me.
</td> </tr>
<tr>
<td>po03</td> <td>
3. I feel like I own donating blood.
</td> </tr>
<tr> <td></td>
<td>
Self-identity
</td> </tr>
<tr>
<td>si01</td>
<td>
1. Donating blood is important to me.
</td> <tr>
<td>si02</td> <td>
2. I am like the kind of person who donates blood.
</td> </tr>
<tr> <td>si03</td> 
<td>
3. Donating blood is an important part of who I am.
</td> </tr>
<tr> <td></td>
<td>
Intention
</td></tr>
<tr><td>it01</td>
<td>
1. I would like to donate blood in the future.
</td>   </tr>
<tr><td>it02</td>
<td>
2. I intend to donate blood in the future.
</td> </tr>
<tr><td>it03</td>
<td>
3. I intend to make more than just a one-off blood donation.
</td></tr>
<tr><td></td>
<td>
Intention to donate for emergency
</td></tr>
<tr><td>ie01</td>
<td>
1. I would be willing to donate blood if I received an urgent callout from the Finnish Red Cross Blood Service.
</td></tr>
<tr><td></td> 
<td>
Antecedents of psychological ownership
</td></tr>
<tr><td></td> 
<td>
Control
</td></tr>
<tr><td>ac01</td>
<td>
1. I have influence over the things that affect me while donating blood.
</td></tr>
<tr><td>ac02</td>
<td>
2. I control the location and scheduling for donating blood.
</td></tr>
<tr><td>ac03</td>
<td>
3. I influence decisions related to my blood donation.
</td></tr>
<tr><td>ac04</td>
<td>
4. In general, I have control over donating blood.
</td></tr>
<tr><td></td>
<td>
Intimate knowledge
</td></tr>
<tr><td>ai01</td>
<td>
1. I am intimately familiar with what is going on with regard to donating blood.
</td></tr>
<tr><td>ai02</td>
<td>
2. I have a depth of knowledge as it relates to donating blood.
</td></tr>
<tr><td>ai03</td>
<td>
3. I have a comprehensive understanding of donating blood.
</td></tr>
<tr><td>ai04</td>
<td>
4. I have a broad understanding of donating blood.
</td></tr>
<tr><td></td>
<td>
Blood donation history
</td></tr>
<tr><td>bd01</td>
<td>
1. Do you believe that you are currently eligible to donate blood [yes, no, unsure]
</td></tr>
<tr><td>bd02</td>
<td>
2. How many times in total have you donated blood at the Finnish Red Cross Blood Service Finland? [select number]
</td></tr>
<tr><td>bd03</td>
<td>
3. How many times in the last two years have you donated at the Finnish Red Cross Blood Service? [select number]
</td></tr>
<tr><td>bd04</td>
<td>
4. When did you last attend a Finnish Red Cross blood donation centre with the intention of donating blood? [select date]
</td></tr>
<tr><td></td>
<td>
Demographics
</td></tr>
<tr><td>de01</td>
<td>1. What is your gender? [man, woman, non-binary, prefer to not disclose, prefer to self-describe (open response)]
</td></tr>
<tr><td>de02</td>
<td>
2. How old are you today? [select number]
</td></tr>
</table>




```{r}
#knitr::knit_exit()
```


```{r}
#Make question abbreviations
qabbr <- c(
    str_c("po0",1:3),
    str_c("si0",1:3),
    str_c("it0",1:3),
    str_c("ie0",1),
    str_c("ac0",1:4),
    str_c("ai0",1:4),
    str_c("bd0",1:4),
    str_c("de0",1:2)
  )

```


## Simulate

All items are scored 1 (strongly disagree) to 7 (strongly agree).

```{r}
#First very rough version

if (TRUE) { # if you have data you set this to false
  n <- 100
  #source("../../responsesR/R/responses.R")
  #create correlation matrix
  #po 3, si 3,  it 3, ie 1, ac 4,ai 4,bd 4, de 2
  #use tidyverse str function to create names str_glue
  R <- matrix(
  #     po          si        it        ie         ac        ai              
  c( 1 ,0.5,0.5,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.5, 1 ,0.5,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.5,0.5, 1 ,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2, 1 ,0.5,0.5,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.5, 1 ,0.5,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.5,0.5, 1 ,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2, 1 ,0.5,0.5,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2,0.5, 1 ,0.5,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2,0.5,0.5, 1 ,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2, 1 ,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2, 1 ,0.5,0.5,0.5,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.5, 1 ,0.5,0.5,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.5,0.5, 1 ,0.5,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.5,0.5,0.5, 1 ,0.2,0.2,0.2,0.2,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2, 1 ,0.5,0.5,0.5,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.5, 1 ,0.5,0.5,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.5,0.5, 1 ,0.5,
    0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.5,0.5,0.5, 1 
    # bd and de are different
    )
  , nrow=18)
    # if you have problems name the columns and rows here
  rownames(R) <- qabbr[1:18]
  colnames(R) <- qabbr[1:18]
  corrplot(R)
  # Only correlations between latents 
}
```



```{r}
#Tried to build to the correlation between latent factors, but...
if (FALSE) { # if you have data you set this to false
  n <- 100
  #create correlation matrix
  #po 3, si 3,  it 3, ie 1, ac 4,ai 4,bd 4, de 2
  R <- matrix(
  #     po           si           it           ie           ac          ai              
  c( 1 ,0.5,0.5,    0.3,0.3,0.3, -0.1,-0.1,-0.1, 0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2,
    0.5, 1 ,0.5,    0.3,0.3,0.3, -0.1,-0.1,-0.1, 0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2, #po
    0.5,0.5, 1 ,    0.3,0.3,0.3, -0.1,-0.1,-0.1, 0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2,

    0.3,0.3,0.3,    1 , 0.5,0.5, 0.7,0.7,0.7,    0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2,
    0.3,0.3,0.3,    0.5, 1 ,0.5, 0.7,0.7,0.7,    0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2, # si
    0.3,0.3,0.3,    0.5,0.5, 1 , 0.7,0.7,0.7,    0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2,
    
    -0.1,-0.1,-0.1, 0.7,0.7,0.7, 1  ,0.5,0.5,    0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2,
    -0.1,-0.1,-0.1, 0.7,0.7,0.7, 0.5, 1 ,0.5,    0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2, #it
    -0.1,-0.1,-0.1, 0.7,0.7,0.7, 0.5,0.5, 1 ,    0.2,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2,
    
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,    1  ,0.2,0.2, 0.2,0.2,0.2, 0.2,0.2,0.2,
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,    0.2, 1 ,0.5, 0.5,0.5,0.2, 0.2,0.2,0.2, # ie
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,    0.2,0.5, 1 , 0.5,0.5,0.2, 0.2,0.2,0.2,
    
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,    0.2,0.5,0.5, 1 , 0.5,0.2, 0.2,0.2,0.2,
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,    0.2,0.5,0.5, 0.5, 1 ,0.2, 0.2,0.2,0.2, # ac
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2, 1 , 0.5,0.5,0.5,
    
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,   0.2,0.2,0.2, 0.2,0.2,0.5,  1 ,0.5,0.5,
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,   0.2,0.2,0.2, 0.2,0.2,0.5, 0.5, 1 ,0.5, # ai
    0.2,0.2,0.2,    0.2,0.2,0.2, 0.2,0.2,0.2,   0.2,0.2,0.2, 0.2,0.2,0.5, 0.5,0.5, 1 
    # bd and de are different. Create them later.
    )
  , nrow=18)
  
  R[R == 0.2] <-0
  rownames(R) <- qabbr[1:18]
  colnames(R) <- qabbr[1:18]
  #Add a bit of noise 
  # R <- R +  matrix(rnorm(n=length(R),mean=0,sd=0.1), nrow=18)
  #Make symmetric
  R[upper.tri(R)] <- t(R)[upper.tri(R)]
  #isSymmetric(R)
  
  R <- R *0.5
  R <- as.matrix(Matrix::nearPD(R)$mat)
  diag(R) <- 1
  #  Rplot <- round(R,digits = 1)
  #  Rplot[Rplot <= -1] <- -1
  #  Rplot[Rplot >= 1] <- 1
  #   # if you have problems name the columns and rows here
  
  #corrplot(Rplot)
  corrplot(R)
  # When calling responsesR:get_responses always get an error
  # Could not figure out how to simulate depencies between latent variables with usein responsesR
  # But it is good enough for developping the script.
  # Error in msn.cp2dp(cp, silent) : non-admissible CP
 
}
```







```{r}
#simulate data with responsesR::get_responses
if (TRUE) {
library(responsesR)
  
  data_likert_7<- get_responses(n = n,
                K = 7,
                mu = rep(1,nrow(R)),
                gamma1 = -0.1,
                sd = 1,
                R=R
  )
  
  de02 <- round(rnorm(n=n,mean=40,sd =10)) # age
  #de01<- genLikert(size = n,items = 1, levels=4, location=c(-1)) #gender
  de01 <- get_responses(n = n,
                K = 4,
                mu = -1,
                gamma1 = -0.1,
                sd = 0.5
  )
  de01 <-     
      case_when(
      de01 == 1 ~ "women",
      de01 == 2 ~ "man",
      de01 == 3 ~ "Non-binary/other",
      de01 == 4 ~ "Don't wish to respond")
  #bd01 <-  genLikert(size = n,items = 1, levels=3, location=c(-1))
  bd01 <- get_responses(n = n,
                        K = 3,
                        mu = -1,
                        gamma1 = 0.5,
                        sd = 0.7
  )
  bd01 <- case_when(
    bd01 == 1 ~ "yes",
    bd01 == 2 ~ "no",
    bd01 == 3 ~ "unsure",
  )
  data <- bind_cols(
    data_likert_7,
    bd01,
    #bd02,
    #bd03,
    #bd04,
    de01,
    de02
  )
  colnames(data) <- qabbr[1:ncol(data)]
  data <- data %>% 
    mutate(
      # to have some relationship between latent variables make donation counts and po correlate
       bd02 = 
      #take this from po 
         round(as.numeric(po01)  +  
                 as.numeric(po02)   + 
                 as.numeric(data$po03) +
      # and sex
                 0.5*as.numeric(as.factor(de01))   + 
      #with some noise
                 rnorm(nrow(data),0,4) ),
      #make sure it never goes below 1
      bd02 = ifelse(bd02 < 2 ,1,bd02),
      # and count donation in last two years from it with some noise
      bd03 = round(ceiling(bd02 / 5) + rnorm(nrow(data),0,1)),
      bd04 = sample(seq(as.Date('2022/01/01'), as.Date('2024/01/01'), by="day"), n)
    )
  
  
  
  summary(data)
}
```



```{r}
# https://stats.stackexchange.com/questions/648242/how-to-simulate-data-for-a-sem-model-with-moderation-effect-using-r 
# https://github.com/RobinDenz1/simDAG
# 
if (FALSE) {
  library(simDAG)

  
  # dag <- empty_dag() +
  #   node("age", type="rnorm", mean=50, sd=4) +
  #   node("sex", type="rbernoulli", p=0.5) +
  #   node("bmi", type="gaussian", formula= ~ 12 + age*1.1 + sex*0.4, error=2) +
  #   node("death", type="binomial", formula= ~ -15 + age*0.1 + bmi*0.3)
  # set.seed(42)
  # sim_dat <- sim_from_dag(dag, n_sim=100000)
  # mod_bmi <- glm(bmi ~ age + sex, data=sim_dat, family="gaussian")
  # summary(mod_bmi)
  # 
#   po =~ po01 + po02 + po03
#                 si =~ si01 + si02 + si03
#                 it =~ it01 + it02 + it03
#                 ac =~ ac01 + ac02 + ac03 + ac04
#                 ai =~ ai01 + ai02 + ai03 + ai04 
# #                bd =~ bd01 + bd02 + bd03 + bd04 #lavaan ERROR: unknown ov.types:Da
#                 bd =~ bd01 + bd02 + bd03
  
# probs1 <- c(0.05,0.1,0.2,0.3,0.2,0.1,0.05)
#                 
# dag <- empty_dag() + 
#   node("po01", type="rcategorical", labels=c(1:7),probs= )+ 
#   po02 + 
#   po03 +
#   si01 + 
#   si02 + 
#   si03 + 
#   it01 + 
#   it02 + 
#   it03 + 
#   ac01 + 
#   ac02 + 
#   ac03 + 
#   ac04 + 
#   ai01 + 
#   ai02 + 
#   ai03 + 
#   ai04 + 
#   bd01 + 
#   bd02 + 
#   bd03 + 
}

```


## Process

```{r}

f1 <- function (x){
  #as numbers but labelled with words
    x <- factor(
    x,
    #levels = c("Strongly disagree","Disagree","Neutral","Agree","Strongly agree"),
    levels = c(1:7),
    ordered = TRUE
  )
  x
}

data <- data %>% 
  mutate_at(
    vars(
      qabbr[1:18]),
    ~ f1(.) 
    ) %>% 
  mutate(bd04 = as.Date(bd04),
         bd01 = factor(bd01, levels = c("no","unsure","yes"),ordered = TRUE),
         de01 = factor(de01)
         )  

summary(data)

```

```{r}
corrplot(cor(data %>% select(-bd01,-bd04,-de01)))

```


# Plot

the responsesR likert plots look really good...


## Demographics Table 1

```{r}

table1 <-
  tbl_summary(
    data %>% 
      # mutate(
      #   bd01 = as.character(bd01) # this did fix this need to think of something
      # ) %>% 
      rename(
      Gender =  de01,
      Age = de02,
      DonationEligibility = bd01,
      DonationCount = bd02,
      DonationCountLast2years = bd03,
    ),
    include = c(
      Age,
      DonationEligibility,
      DonationCount,
      DonationCountLast2years
      ),
    by =  Gender
    
  ) %>%
  add_n()  # add column with total number of non-missing observations
table1
```



## Age by Gender

```{r}

p <- ggplot(data)
p <- p +  geom_histogram(aes(x=de02),binwidth = 5)
p <- p + facet_wrap(. ~ de01)
p <- p + xlab("Age in years")
p

```



## Psychological ownership

```{r , warning=FALSE}
nlevels = 7

items = data %>% 
    select(which(str_detect(colnames(data) ,"^po"))) 

#rename the questions in here from metadata

qpo <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(qpo, 
     type = "heat",
     legend.position = "bottom",
     text.size=3,
     include.histogram = FALSE)
```

```{r}

gglikert(
  data %>% 
    select(which(str_detect(colnames(data) ,"^po"))) 
)

```




## Self-identity


```{r , warning=FALSE}

items = data %>% 
    select(which(str_detect(colnames(data) ,"^si"))) 

#rename the questions in here from metadata
qsi <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(qsi, 
     type = "heat",
     legend.position = "bottom",
     text.size=3,
     include.histogram = FALSE)
```


## Intention

```{r , warning=FALSE}

items = data %>% 
    select(which(str_detect(colnames(data) ,"^it"))) 

#rename the questions in here from metadata
qit <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(qit, 
     type = "heat",
     legend.position = "bottom",
     text.size=3,
     include.histogram = FALSE)
```


## Intention to donate for emergency

```{r , warning=FALSE}

items = data %>% 
    select(which(str_detect(colnames(data) ,"^ie"))) 

#rename the questions in here from metadata
qie <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(qie, 
     type = "heat",
     legend.position = "bottom",
     text.size=3,
     include.histogram = FALSE)
```


## Antecedents of psychological ownership - Control

```{r , warning=FALSE}

items = data %>% 
    select(which(str_detect(colnames(data) ,"^ac"))) 

#rename the questions in here from metadata
qac <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(qac, 
     type = "heat",
     legend.position = "bottom",
     text.size=3,
     include.histogram = FALSE)
```


## Antecedents of psychological ownership - Intimate knowledge


```{r , warning=FALSE}

items = data %>% 
    select(which(str_detect(colnames(data) ,"^ai"))) 

#rename the questions in here from metadata
qai <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(qai, 
     type = "heat",
     legend.position = "bottom",
     text.size=3,
     include.histogram = FALSE)
```


# Model


```{r}

library(lavaan)
#library(blavaan) # tidySEM requires blavaan
#library(tidySEM) # https://github.com/yrosseel/lavaan/issues/359

```


## Confirmatory factor analysis

```{r}
isordered <- data %>%  summarise(across(everything(), ~ is.ordered(.x))) %>%  as.logical() %>% which()
isfactor <- data %>%  summarise(across(everything(), ~ is.factor(.x))) %>%  as.logical() %>% which()

#lavaan does not understand empty factor levels
data.fit <- data %>%
  #lavaan cannot deal with unordered factor with more then 2 levels
  filter(de01 == 'man' | de01 == "women") %>% 
  mutate(
    across(isfactor, ~ fct_drop(.x)
    ) 
  )

```




```{r}

po01.model <- ' po =~ po01 + po02 + po03
                si =~ si01 + si02 + si03
                it =~ it01 + it02 + it03
                ac =~ ac01 + ac02 + ac03 + ac04
                ai =~ ai01 + ai02 + ai03 + ai04 
#                bd =~ bd01 + bd02 + bd03 + bd04 #lavaan ERROR: unknown ov.types:Da
                bd =~ bd01 + bd02 + bd03
'
                
fit.po01.cfa <- cfa(po01.model,  
                    estimator = "DWLS",
                    data = data.fit)

lavaan::summary(fit.po01.cfa,standardized = TRUE) # tidySEM is loaded this fails!
#lavaan::summary(fit.po01.cfa,std.nox = FALSE)
```

## SEM


```{r}
#https://stats.stackexchange.com/questions/340857/serial-mediation-in-r-how-to-setup-the-model

po02.model <- ' 
#measurement model
psycown =~ po01 + po02 + po03
selfid =~ si01 + si02 + si03
intention =~ it01 + it02 + it03
#psycown_cont =~ ac01 + ac02 + ac03 + ac04
#psycown_know =~ ai01 + ai02 + ai03 + ai04 
blooddonor =~ bd01 + bd02 + bd03 
#mediation
psycown ~ a1 *  blooddonor
selfid ~ a2 * blooddonor + d21 * psycown
#regression
intention ~  de01 + de02 + ie01 +  cp * blooddonor + b1 * psycown + b2 * selfid
ind_eff := a1* d21 * b2
'



```


```{r}
#fit
                
fit.po02 <- cfa(po02.model,  
                    estimator = "DWLS",
                    data = data.fit)

lavaan::summary(fit.po02,standardized = TRUE)

```



```{r}
#fit.po02.boot <- bootstrapLavaan(fit.po02)
#Error: lavaan->bootstrapLavaan(): 
#this function is not (yet) available if conditional.x = TRUE
```

